name: compiling web_search.exe

on:
  workflow_dispatch: 

jobs:
  build:
    runs-on: windows-latest  
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Auto-increment version
        id: increment_version
        shell: pwsh
        run: |
          $cargoPath = "web_search/Cargo.toml"
          $cargoContent = Get-Content $cargoPath
          $versionLine = $cargoContent | Select-String -Pattern 'version\s*=\s*"([^"]+)"'
          $currentVersion = $versionLine.Matches.Groups[1].Value
          $versionParts = $currentVersion.Split('.')
          $newPatch = [int]$versionParts[2] + 1
          $newVersion = "$($versionParts[0]).$($versionParts[1]).$newPatch"
          $newVersionLine = 'version = "' + $newVersion + '"'
          $cargoContent = $cargoContent -replace $versionLine, $newVersionLine
          Set-Content -Path $cargoPath -Value $cargoContent
          echo "NEW_VERSION=$newVersion" >> $env:GITHUB_OUTPUT
          echo "New version: $newVersion"

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: Bump version to ${{ steps.increment_version.outputs.NEW_VERSION }}"
          file_pattern: web_search/Cargo.toml
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc  
      
      - name: Build release binary
        working-directory: ./web_search
        run: cargo build --release --target x86_64-pc-windows-msvc
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: web_search-x64
          path: web_search/target/x86_64-pc-windows-msvc/release/web_search.exe
      
      - name: Get version from Cargo.toml
        id: version
        shell: pwsh
        run: |
          $version = "${{ steps.increment_version.outputs.NEW_VERSION }}"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          files: web_search/target/x86_64-pc-windows-msvc/release/web_search.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
